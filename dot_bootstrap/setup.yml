- name: Configure tools for general environment
  hosts: localhost
  become: true
  connection: local
  gather_facts: true

  tasks:
    - name: Detect if inside of wsl
      register: is_wsl
      ignore_errors: true
      script: "utils.sh is_wsl"
      args:
        executable: "/usr/bin/env bash"

    # Arch
    - name: Update and upgrade
      pacman:
        update_cache: true
        upgrade: true
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Install command line utilities
      pacman:
        name: [
          "git", "git-delta", "make", "tmux", "base-devel", "unzip", "zip",
          "ripgrep", "zoxide", "bat", "jq", "fzf", "btop", "tree", "github-cli",
          "tmux", "pass", "neovim", "starship", "python-cookiecutter"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Install programming languajes support
      pacman:
        name: [
          "lua-language-server", "bash-language-server"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Install nvidia drivers
      pacman:
        name: [
          "nvidia-open"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Install x11 dependencies
      pacman:
        name: [
          "xorg", "xorg-xinit", "xclip", "xorg-fonts", "pango"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Install Fonts
      pacman: 
        name: [
          "noto-fonts-emoji", "nerd-fonts", "monaspace-font", "fontconfig"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Install WM
      pacman:
        name: [
          "awesome", "picom", "feh", "polybar"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Images and capture
      pacman:
        name: [
          "sxiv", "zathura", "zathura-pdf-mupdf", "zathura-djvu",
          "zathura-ps", "mpv", "inkscape", "scrot", "obs-studio",
          "shotcut"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Docker
      pacman:
        name: [
          "docker", "docker-compose", "nvidia-container-toolkit"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Note taking
      pacman:
        name: [
          "obsidian"
        ]
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Create the `aur_builder` user
      become: yes
      ansible.builtin.user:
        name: aur_builder
        create_home: yes
        group: wheel
      when: ansible_facts["distribution"] == "Archlinux"

    - name: Allow the `aur_builder` user to run `sudo pacman` without a password
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/11-install-aur_builder
        line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
        create: yes
        mode: 0644
        validate: 'visudo -cf %s'
      when: ansible_facts["distribution"] == "Archlinux"

    - name: AUR packages
      become: yes
      become_user: aur_builder
      kewlfft.aur.aur:
        name: [
          "google-chrome", "nodejs-compose-language-service", "dockerfile-language-server",
          "cagent-bin"
        ]
        use: makepkg
      when: ansible_facts["distribution"] == "Archlinux"


    # Debian
    - name: Update and upgrade
      apt:
        update_cache: true
        upgrade: true
      when: ansible_facts["os_family"] == "Debian"

    - name: Install command line utilities
      apt:
        name: [
          "git", "tmux", "build-essential", "unzip", "zip", "ripgrep", "jq", "btop",
          "tree", "tmux", "pass", "curl", "zoxide", "bat"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian"

    - name: Install neovim build dependencies
      apt:
        name: ["gettext", "cmake", "build-essential", "cmake", "ninja-build", "gettext"]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian"

    - name: Install Neovim
      script: "build.sh nvim v0.11.0"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian"

    - name: Install Rust
      script: "build.sh rust"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Alacritty Dependencies
      apt:
        name: [
          "cmake", "g++", "pkg-config", "libfreetype6-dev", "libfontconfig1-dev", "libxcb-xfixes0-dev",
          "libxkbcommon-dev", "python3"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Install Alacritty
      script: "build.sh alacritty"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Install fzf
      script: "build.sh fzf"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian"

    - name: Install starship
      script: "build.sh starship"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian"

    - name: Install x11 dependencies
      apt:
        name: [
          "xorg", "xinit", "xclip"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Install WM and DM
      apt:
        name: [
          "awesome", "feh", "polybar"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Picom Dependencies
      apt:
        name: [
          "libconfig-dev", "libdbus-1-dev", "libegl-dev", "libev-dev", "libgl-dev", "libepoxy-dev",
          "libpcre2-dev", "libpixman-1-dev", "libx11-xcb-dev", "libxcb1-dev", "libxcb-composite0-dev",
          "libxcb-damage0-dev", "libxcb-glx0-dev", "libxcb-image0-dev", "libxcb-present-dev",
          "libxcb-randr0-dev", "libxcb-render0-dev", "libxcb-render-util0-dev", "libxcb-shape0-dev",
          "libxcb-util-dev", "libxcb-xfixes0-dev", "meson", "ninja-build", "uthash-dev"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Install Picom
      script: "build.sh picom"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Images and capture
      apt:
        name: [
          "sxiv", "zathura", "zathura-pdf-poppler", "zathura-djvu", "zathura-ps", "inkscape", "mpv",
          "scrot", "obs-studio"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Install Fonts
      apt: 
        name: [
          "fonts-noto-color-emoji"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Install Monaspace Font
      script: "build.sh monaspace"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["os_family"] == "Debian" and not is_wsl

    - name: Setup docker
      script: "build.sh docker-ubuntu"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["distribution"] == "Ubuntu"

    - name: Setup docker
      script: "build.sh docker-debian"
      args:
        executable: "/usr/bin/env bash"
      when: ansible_facts["distribution"] == "Debian"

    - name: Install docker
      apt:
        name: [
          "docker-ce", "docker-ce-cli", "containerd.io", "docker-buildx-plugin", "docker-compose-plugin"
        ]
        install-recommends: false
      when: ansible_facts["os_family"] == "Debian"

      
